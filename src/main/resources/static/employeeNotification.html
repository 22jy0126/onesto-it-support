<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TODO: ページの名にチェンジする -->
    <title>通知画面</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- システム共用のスタイルはこのファイルに追加する -->
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/employeeNotification.css">
    <!-- TODO: 作るHTMLとペアでCSSファイルを作り、なるべく同じファイル名にする -->

    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>

<body>
    <el-container id="app" v-cloak>
        <!-- ヘッドの部分 各々の画面は同じです -->
        <header class="common-header">
            <div class="logo">
                ブリッジ
            </div>
            <div class="login-info">
                {{user.name}}さん、こんにちは！
                <span class="logout" @click="logout">ログアウト</span>
            </div>
        </header>

        <!-- メインの部分 -->
        <el-container class="common-mian notice-case-main">
            <!-- サイドメニュー -->
            <el-aside width="200px">
                <!-- TODO: default-active は今いるのメニューです -->
                <el-menu default-active="4" class="el-menu-vertical-demo">
                    <el-menu-item index="1" @click="goJobCases">求人一覧</el-menu-item>
                    <el-menu-item index="2" @click="goEmployeeInfo">個人履歴</el-menu-item>
                    <el-menu-item index="3" @click="goEmployeeApplyHistory">応募履歴</el-menu-item>
                    <el-menu-item index="4">
                        <el-badge v-if="noticeCount > 0" :value="noticeCount" class="notice-badge">
                            <div>通知</div>
                        </el-badge>
                        <div v-if="noticeCount == 0">通知</div>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-main>
                    <!-- TODO: 内容はここに書く -->
                    <section class="employee-Notification">
                        <div class="common-caption">
                            <i class="el-icon-message-solid icon"></i>
                            <span class="em">通知一覧</span>
                        </div>
                        <el-empty v-if="notices.length == 0" description="只今、通知がありません"></el-empty>
                        <div class="notice-case-item" v-for="notice in notices">
                            <div v-if="notice.readed == 0" class="read-mark read-mark-0">
                                未読
                            </div>
                            <div v-if="notice.readed == 1" class="read-mark read-mark-1">
                                既読
                            </div>
                            <div class="date">
                                <span>{{notice.date}}</span>
                            </div>
                            <div class="msg-wrapper">
                                <div class="name">案件名：{{notice.caseName}}</div>
                                <div>メッセージ：{{notice.msg}}</div>
                            </div>
                            <div class="go-detail"
                                @click="goDetail(notice)"
                            >
                                詳細>>
                            </div>
                        </div>
                    </section>
                </el-main>
            </el-container>
        </el-container>
    </el-container>

</body>

</html>
<script src="./js/utils.js"></script>
<script src="./js/pageJump.js"></script>
<script>
    // elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja);

    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data() {
            return {
                // ログインしたユーザー情報
                user: {},
                notices: [],
                noticeCount: 0,
                linkTypeMap: [{
                    /* 案件開始 */
                    type: 1001,
                    goMethod: goCaseDetail,
                    msg: "おめでとうございます！あなたは応募した案件が開始されました、",
                }, {
                    /* マイルストーンのチェック返信 */
                    type: 1002,
                    goMethod: goCaseDetail,
                    msg: "クライアントからマイルストーンの編集について返信があります、",
                }, {
                    /* マイルストーンの編集確認完了 */
                    type: 1003,
                    goMethod: goCaseDetail,
                    msg: "クライアントからマイルストーンの編集に確認しました、",
                }, {
                    /* マイルストーンの更新チェック返信 */
                    type: 1004,
                    goMethod: goCaseDetail,
                    msg: "クライアントからマイルストーンの進捗更新について返信があります、",
                }, {
                    /* マイルストーンの更新確認完了 */
                    type: 1005,
                    goMethod: goCaseDetail,
                    msg: "クライアントからマイルストーンの進捗更新に確認しました、",
                }, {
                    /* 案件完了確認 */
                    type: 1006,
                    goMethod: goCaseDetail,
                    msg: "お疲れ様でした！クライアントから案件作業完了が確認されました、"
                }],
            };
        },
        mounted() {
            const userStr = sessionStorage.getItem("userinfo") || "";
            if (userStr != "") {
                const user = JSON.parse(userStr);
                if (user.type != 2) {
                    goLogin(1);
                } else {
                    this.user = user;
                    const { employeeId } = user;
                    this.getNotices(employeeId);
                }
            } else {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/login/info",
                    withCredentials: true,
                })
                    .then((res) => {
                        loading.close();
                        const { data: {
                            code,
                            data: user = {},
                        } = {} } = res;
                        if (code != 80011 || user.type != 2) {
                            goLogin();
                        } else {
                            this.user = user;
                            sessionStorage.setItem("userinfo", JSON.stringify(user));
                            const { employeeId } = user;
                            this.getNotices(employeeId);
                        }
                    })
            }
        },
        methods: {
            goJobCases,
            goEmployeeInfo,
            goCaseDetail,
            goEmployeeApplyHistory,
            getNotices(employeeId) {
                axios({
                    method: "GET",
                    url: `/logged/emp/notice/list/${employeeId}`,
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        const { data: {
                            code,
                            data = [],
                        } = {} } = res;
                        let noticeCount = 0;
                        const notices = [];
                        const tmp = [];
                        data.forEach((n = {}) => {
                            const { readed, type, createDate } = n;
                            const date = dateFormat(createDate);
                            const nt = this.linkTypeMap.find(({ type: ty }) => ty == type);
                            n.date = date;
                            n.goMethod = nt.goMethod;
                            n.msg = `${nt.msg}詳細を確認してください！`;
                            if (readed == 0) {
                                noticeCount++;
                                notices.push(n);
                            } else {
                                tmp.push(n);
                            }
                        });
                        this.noticeCount = noticeCount;
                        notices.push(...tmp);
                        this.notices = notices;
                    });
            },
            goDetail(notice) {
                const {
                    goMethod,
                    caseId,
                    id,
                } = notice;
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                })
                axios({
                    method: "GET",
                    url: `/logged/emp/notice/readed/${id}`,
                    withCredentials: true,
                })
                    .then(() => {
                        goMethod(caseId, 1);
                    });
            },
            logout() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/logout",
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        loading.close();
                        const { data: {
                            code,
                            msg = "",
                        } = {} } = res;
                        this.$message.success(msg);
                        sessionStorage.removeItem("userinfo");
                        setTimeout(() => goLogin(1), 1000);
                    });
            }
        },
    });
</script>