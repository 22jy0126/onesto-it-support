<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TODO: ページの名にチェンジする -->
    <title>登録案件閲覧画面</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- システム共用のスタイルはこのファイルに追加する -->
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/jobCase.css">
    <!-- TODO: 作るHTMLとペアでCSSファイルを作り、なるべく同じファイル名にする -->
	<link rel="stylesheet" href="./css/customerCaseView.css">
    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
    <el-container id="app">
        <!-- ヘッドの部分 各々の画面は同じです -->
        <header class="common-header">
            <div class="logo">
                ブリッジ
            </div>
            <div class="login-info">
                {{user.name}}さん、こんにちは！
				<span class="logout" @click="logout">ログアウト</span>
            </div>
        </header>

        <!-- メインの部分 -->
        <el-container class="common-mian job-case-main">
            <!-- サイドメニュー -->
            <el-aside width="200px">
                <!-- TODO: default-active は今いるのメニューです -->
                <el-menu default-active="1" class="el-menu-vertical-demo">
					<el-menu default-active="2" class="el-menu-vertical-demo">
						<el-menu-item index="1" @click="goCustomerCaseEdit">新規案件登録</el-menu-item>
						<el-menu-item index="2">私の案件</el-menu-item>
						<el-menu-item index="3">通知</el-menu-item>
					</el-menu>
                </el-menu>
            </el-aside>

            <el-container>
                <el-main>
                    <!-- 登録案件リスト -->
	                <section>
	                    <div class="common-caption">
	                        <i class="el-icon-files icon"></i>
	                        登録案件リスト
	                    </div>
	                    <div class="job-case-item" v-for="job in jobList">
							<div class="case-name-line">
								<div class="title">
									<div class="case-name">{{job.cb.caseName}}</div>
									<div v-bind:class="job.cb.statusCls">
										{{job.cb.applyStatusText}}
									</div>
								</div>
								<!-- <div class="case-name">{{job.cb.caseName}}</div> -->
								<div>
									<span>開発期限:</span>
									<span>{{job.cb.deadlineVal}}</span>
								</div>
							</div>
							<div class="case-sub">
								<div class="case-sub-money">
									<span class="label">報酬:&nbsp;&nbsp;&nbsp;</span>
									<span>{{(job.cb.bonusMoney|| 0).toLocaleString()}}万円</span>
									<span>{{job.cb.bonusMoneyNegotiable ? "(相談可能)" : ""}}</span>
								</div>
							</div>
							<div class="case-sub">
								<span class="label">希望開発ツール:&nbsp;&nbsp;&nbsp;</span>
								<span>{{job.cb.developTools}}</span>
							</div>
							<div class="case-sub">
								<span class="label">説明:&nbsp;&nbsp;&nbsp;</span>
								<span>{{job.cb.description}}</span>
							</div>
	                        
	                        <div class="go-detail" @click="goCustomerCaseDetail(job.cb.caseId)">
	                            詳細>>
	                        </div>     
	                        
	                        <!-- 応募者リスト -->
					        <div class="applicants-list" v-if="job.cb.status == 1">
					            <div class="common-caption">
					                <i class="el-icon-user icon"></i>
					                応募者リスト
					            </div>
					            <!--応募人数-->
					            <div v-bind:class="((job.cb.apylist || []).length == 0) ? 'hidden' : ''" >
									<span class="applicantLength">
										{{(job.apylist || []).length}}
									</span>	
									人が応募しています
								</div>
					            <div v-if="(job.apylist || []).length > 0">
					                <!-- 応募者がいる場合 -->
					                <div v-for="applicant in job.apylist" class="applicant-item">
					                    <div class="applicant-info">	
											<el-row>
												<el-col>
													<el-card shadow="hover">
														<div class="applicant-user">
															<div>
																<div class="name">
																	{{applicant.name}}
																</div>
																<div>
																	<span class="apy-label">性別:&nbsp;&nbsp;&nbsp;<span>{{applicant.gender == 0 ? "男性" : "女性"}}</span></span>
																	<span class="apy-label">生年月日:&nbsp;&nbsp;&nbsp;<span>{{applicant.birthdayVal}}</span></span>
																</div>
																<div>
																	<span class="apy-label">経験開発ツール:&nbsp;&nbsp;&nbsp;<span>{{applicant.skill == null ? "未記入" : applicant.skill}}</span></span>
																</div>
															</div>
															<div class="go-detail" @click="goCustomerEmpInfo(applicant.employeeId, job.cb.caseId)">
																詳細>>
															</div>
														</div>
													</el-card>
												</el-col>
											</el-row>
										</div>
									</div>
					            </div>
					            <div v-else>
					                <!-- 応募者がいない場合 -->
					                <div class="no-applicants">現在の応募者はいません。</div>
				            	</div>
					        </div>
	                        
	                    </div>
	                </section>
                    
                </el-main>
            </el-container>
        </el-container>
    </el-container>

</body>

</html>
<script src="./js/pageJump.js"></script>
<script src="./js/utils.js"></script>
<script>
    // elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja);

    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data() {
            return {
                // ログインしたユーザー情報
                user: {
                    avatarUrl: "https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png", //アバター画像
                    username: "鈴木　奈々", // ユーザー名
                    noticeCount: 2, // 通知数
                },
                // 登録した求人票のデータ
				jobList: [],
            };
        },
		mounted() {
			// ユーザー情報をゲット
			const userStr = sessionStorage.getItem("userinfo") || "";
			if (userStr != "") {
				const user = JSON.parse(userStr);
				if (user.type != 1) {
					goLogin();
				} else {
					this.user = user;
				}
			} else {
				const loading = this.$loading({
					lock: true,
					text: 'Loading',
					spinner: 'el-icon-loading',
					background: 'rgba(0, 0, 0, 0.1)'
				});
				axios({
					method: "GET",
					url: "/login/info",
					withCredentials: true,
				})
					.then((res) => {
						loading.close();
						const { data: {
							code,
							data: user = {},
						} = {} } = res;
						if (code != 80011 || user.type != 1) {
							goLogin();
						} else {
							this.user = user;
							this.jobCase.customerId = user.customerId;
							sessionStorage.setItem("userinfo", JSON.stringify(user));
						}
					})
			}

			// 私の案件リストをゲット
			const loading = this.$loading({
				lock: true,
				text: 'Loading',
				spinner: 'el-icon-loading',
				background: 'rgba(0, 0, 0, 0.1)'
			});
			axios({
				method: "GET",
				url: "/logged/case/getMyCases",
				withCredentials: true,
			})
				.then((res = {}) => {
					loading.close();
					const { data: {
						code,
						data: jobList = [],
					} = {} } = res;
					this.jobList = jobList.map((job = {}) => {
						const cb = { ...job.cb };
						const apylist = [...(job.apylist || [])];
						const { deadline, status, bind } = cb;
						const deadlineVal = dateFormat(deadline);
						cb.deadlineVal = deadlineVal;

						if (status == 1) {
							cb.applyStatus = 1;
							cb.applyStatusText = "応募中";
							cb.statusCls = "status status-1";
						}
						if (status == 2) {
							cb.applyStatus = 3;
							cb.applyStatusText = "案件作業中";
							cb.statusCls = "status status-3";
						}
						if (status == 3) {
							cb.applyStatus = 4;
							cb.applyStatusText = "案件作業終了";
							cb.statusCls = "status status-4";
						}

						apylist.forEach((emp = {}) => {
							const { birthday } = emp;
							const birthdayVal = dateFormat(birthday);
							emp.birthdayVal = birthdayVal;
						});

						job.cb = cb;
						return job;
					});
					
				})
		},
		methods: {
			goCustomerCaseEdit,
			goCustomerEmpInfo,
			goCustomerCaseDetail,
			logout() {
				const loading = this.$loading({
					lock: true,
					text: 'Loading',
					spinner: 'el-icon-loading',
					background: 'rgba(0, 0, 0, 0.1)'
				});
				axios({
					method: "GET",
					url: "/logout",
					withCredentials: true,
				})
					.then((res = {}) => {
						loading.close();
						const { data: {
							code,
							msg = "",
						} = {} } = res;
						this.$message.success(msg);
						sessionStorage.removeItem("userinfo");
						setTimeout(() => goLogin(1), 1000);
					});
			},
		}
    });
</script>