<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>求人一覧</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link href="./css/common.css" rel="stylesheet"/>
    <link rel="stylesheet" href="./css/jobCase.css">
    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
<el-container id="app" v-cloak>
    <!-- ヘッドの部分 各々の画面は同じです -->
    <header class="common-header">
        <div class="logo">
            ブリッジ
        </div>
        <div class="login-info">
            {{user.name}}さん、こんにちは！
            <span class="logout" @click="logout">ログアウト</span>
        </div>
    </header>

    <!-- メインの部分 -->
    <el-container class="common-mian job-case-main">
        <!-- サイドメニュー -->
        <el-aside width="200px">
            <el-menu
                    default-active="1"
                    class="el-menu-vertical-demo">
                <el-menu-item index="1">求人一覧</el-menu-item>
                <el-menu-item index="2" @click="goEmployeeInfo">個人履歴</el-menu-item>
                <el-menu-item index="3" @click="goEmployeeApplyHistory">応募履歴</el-menu-item>
                <el-menu-item index="4" @click="goEmployeeNotification">
                    <el-badge v-if="noticeCount > 0" :value="noticeCount" class="notice-badge">
                        <div>通知</div>
                    </el-badge>
                    <div v-if="noticeCount == 0">通知</div>
                </el-menu-item>
            </el-menu>
        </el-aside>

        <el-container>
            <el-main>
                <!-- 求人票検索 -->
                <section class="job-case-search-container">
                    <div class="common-caption">
                        <i class="el-icon-search icon"></i>
                        お気の入り求人を検索してください
                    </div>
                    <div class="job-case-search">
                        <div class="search-item">
                            <div class="search-label">
                                求人名
                            </div>
                            <el-input
                                    clearable
                                    placeholder="求人名を入力して検索"
                                    v-model="search.caseName">
                            </el-input>
                        </div>
                        <div class="search-item">
                            <div class="search-label">
                                報酬
                            </div>
                            <el-input-number v-model="search.bonusMoney" :min="0.1" :max="99999">
                            </el-input-number>
                            <div class="mark">万円以上</div>
                        </div>
                        <div class="search-item">
                            <el-button type="primary" @click="searchCases">検索</el-button>
                            <el-button type="info" @click="searchReset">リセット</el-button>
                        </div>
                    </div>
                </section>

                <!-- 求人票リスト -->
                <section>
                    <div class="common-caption">
                        <i class="el-icon-document icon"></i>
                        合計<span class="em">{{totalCount}}件</span>の求人案件を見つかりました
                    </div>
                    <div class="job-case-item" v-for="job in jobList">
                        <div class="case-name-line">
                            <div class="case-name">{{job.caseName}}</div>
                            <div>
                                <span>業務期間:</span>
                                <span>{{job.deadlineVal}}</span>
                            </div>
                        </div>
                        <div class="case-sub">
                            <div class="case-sub-money">
                                <span class="label">報酬(税別):&nbsp;&nbsp;&nbsp;</span>
                                <span>{{+parseFloat(job.bonusMoney*0.9).toFixed(1).toLocaleString()}}万円</span>
                                <span>{{job.bonusMoneyNegotiable ? "(相談可能)" : ""}}</span>
                            </div>
                        </div>
                        <div class="case-sub">
                            <span class="label">希望開発ツール:&nbsp;&nbsp;&nbsp;</span>
                            <span>{{job.developTools}}</span>
                        </div>
                        <div class="case-sub">
                            <span class="label">説明:&nbsp;&nbsp;&nbsp;</span>
                            <span>{{job.description}}</span>
                        </div>
                        <div 
                            class="go-detail"
                            @click="goCaseDetail(job.caseId)"
                        >
                            詳細>>
                        </div>
                    </div>
                </section>
                <!-- ページ -->
                <section>
                    <el-pagination 
                        layout="prev, pager, next" 
                        :page-size="10"
                        :current-page="search.pageNum"
                        @current-change="onCurrentPageChange"
                        :total="totalCount">
                    </el-pagination>
                </section>
            </el-main>
        </el-container>
    </el-container>
</el-container>

</body>
</html>
<script src="./js/pageJump.js"></script>
<script src="./js/utils.js"></script>
<script>
    // elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja);

    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data() {
            return {
                // ログインしたユーザー情報
                user: {},
                noticeCount: 0,
                // 求人票のデータ
                jobList: [{
                    caseName: "学生管理システムの制作",         // 求人プロジェクト名
                    bonusMoney: 5,                    //　報酬
                    bonusMoneyNegotiable: true,             //　報酬相談可能
                    developTools: "C言語で開発・GoogleChatでコミュニケーション・Wordで資料を作成",  // 希望開発ツール
                    description: "学生の個人情報を管理して、保護者との連絡.............",   // 求人の説明
                    deadline: "2024年2月20日"                // 業務期間
                }, {
                    caseName: "学生管理システムの制作",         // 求人プロジェクト名
                    bonusMoney: 5,                    //　報酬
                    bonusMoneyNegotiable: true,             //　報酬相談可能
                    developTools: "C言語で開発・GoogleChatでコミュニケーション・Wordで資料を作成",  // 希望開発ツール
                    description: "学生の個人情報を管理して、保護者との連絡.............",   // 求人の説明
                    deadline: "2024年2月20日"                // 業務期間
                }, {
                    caseName: "学生管理システムの制作",         // 求人プロジェクト名
                    bonusMoney: 5,                    //　報酬
                    bonusMoneyNegotiable: true,             //　報酬相談可能
                    developTools: "C言語で開発・GoogleChatでコミュニケーション・Wordで資料を作成",  // 希望開発ツール
                    description: "学生の個人情報を管理して、保護者との連絡.............",   // 求人の説明
                    deadline: "2024年2月20日"                // 業務期間
                }, {
                    caseName: "学生管理システムの制作",         // 求人プロジェクト名
                    bonusMoney: 5,                    //　報酬
                    bonusMoneyNegotiable: true,             //　報酬相談可能
                    developTools: "C言語で開発・GoogleChatでコミュニケーション・Wordで資料を作成",  // 希望開発ツール
                    description: "学生の個人情報を管理して、保護者との連絡.............",   // 求人の説明
                    deadline: "2024年2月20日"                // 業務期間
                }, {
                    caseName: "学生管理システムの制作",         // 求人プロジェクト名
                    bonusMoney: 5,                    //　報酬
                    bonusMoneyNegotiable: true,             //　報酬相談可能
                    developTools: "C言語で開発・GoogleChatでコミュニケーション・Wordで資料を作成",  // 希望開発ツール
                    description: "学生の個人情報を管理して、保護者との連絡.............",   // 求人の説明
                    deadline: "2024年2月20日"                // 業務期間
                }],
                // 求人票の検索
                search: {
                    pageSize: 10,
                    status: 1,
                },
                pageNum: 1,
                totalCount: 0,
            };
        },
        mounted() {
            // ユーザー情報をゲット
            const userStr = sessionStorage.getItem("userinfo") || "";
            if (userStr != "") {
                const user = JSON.parse(userStr);
                if (user.type != 2) {
                    goLogin(1);
                } else {
                    this.user = user;
                    axios({
                        method: "GET",
                        url: `/logged/emp/notice/${user.employeeId}`,
                        withCredentials: true,
                    })
                        .then((res = {}) => {
                            const { data: {
                                code,
                                data: noticeCount,
                            } = {} } = res;
                            this.noticeCount = noticeCount;
                        });
                }
            } else {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/login/info",
                    withCredentials: true,
                })
                    .then((res) => {
                        loading.close();
                        const { data: {
                            code,
                            data: user = {},
                        } = {} } = res;
                        if (code != 80011 || user.type != 2) {
                            goLogin();
                        } else {
                            this.user = user;
                            sessionStorage.setItem("userinfo", JSON.stringify(user));
                            axios({
                                method: "GET",
                                url: `/logged/emp/notice/${user.employeeId}`,
                                withCredentials: true,
                            })
                                .then((res = {}) => {
                                    const { data: {
                                        code,
                                        data: noticeCount,
                                    } = {} } = res;
                                    this.noticeCount = noticeCount;
                                });
                        }
                    })
            }
            this.searchCases();
        },
        methods: {
            goEmployeeInfo,
            goEmployeeApplyHistory,
            goCaseDetail,
            goEmployeeNotification,
            searchCases() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "POST",
                    url: "/logged/case/getByPage",
                    data: {
                        ...this.search,
                        fromNum: (this.pageNum - 1) * 10,
                        status: 1,
                    },
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        loading.close();
                        const { data: {
                            code,
                            data = {},
                        } = {} } = res;
                        if (code == 20041) {
                            const {
                                list = [],
                                totalCount,
                            } = data;
                            this.totalCount = totalCount;
                            list.forEach((item = {}) => {
                                const { deadline } = item;
                                const deadlineVal = dateFormat(deadline);
                                item.deadlineVal = deadlineVal;
                            });
                            this.jobList = list;
                        }
                    })
            },
            onCurrentPageChange(p) {
                this.pageNum = p;
                this.searchCases();
            },
            logout() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/logout",
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        loading.close();
                        const { data: {
                            code,
                            msg = "",
                        } = {} } = res;
                        this.$message.success(msg);
                        sessionStorage.removeItem("userinfo");
                        setTimeout(() => goLogin(1), 1000);
                    });
            },
            searchReset() {
                this.search = {
                    pageSize: 10,
                };
                this.pageNum = 1;
                this.searchCases();
            }
        }
    });
</script>