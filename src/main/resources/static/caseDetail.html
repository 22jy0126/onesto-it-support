<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TODO: ページの名にチェンジする -->
    <title>案件の詳細</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- システム共用のスタイルはこのファイルに追加する -->
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/jobCase.css" />
    <!-- TODO: 作るHTMLとペアでCSSファイルを作り、なるべく同じファイル名にする -->
    <link rel="stylesheet" href="./css/customerCaseDetail.css" />

    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
    <el-container id="app" v-cloak>
        <!-- ヘッドの部分 各々の画面は同じです -->
        <header class="common-header">
            <div class="logo">
                ブリッジ
            </div>
            <div class="login-info">
                {{user.name}}さん、こんにちは！
                <span class="logout" @click="logout">ログアウト</span>
            </div>
        </header>

        <!-- メインの部分 -->
        <el-container class="common-mian job-case-main">
            <!-- サイドメニュー -->
            <el-aside width="200px">
                <!-- TODO: default-active は今いるのメニューです -->
                <el-menu default-active="1" class="el-menu-vertical-demo">
                    <el-menu-item index="1" @click="goJobCases">求人一覧</el-menu-item>
                    <el-menu-item index="2" @click="goEmployeeInfo">個人履歴</el-menu-item>
                    <el-menu-item index="3" @click="goEmployeeApplyHistory">応募履歴</el-menu-item>
                    <el-menu-item index="4" @click="goEmployeeNotification">
                        <el-badge v-if="noticeCount > 0" :value="noticeCount" class="notice-badge">
                            <div>通知</div>
                        </el-badge>
                        <div v-if="noticeCount == 0">通知</div>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <el-container class="customer-case-detail-container">
                <el-main>
                    <div class="goback">
                        <span @click="goBack" class="back">
                            <i class="el-icon-back"></i>
                            戻る
                        </span>
                    </div>
                    <section>
                        <div class="caption-wrapper">
                            <i class="el-icon-s-order"></i>
                            <div class="caption">案件の基本情報</div>
                            <div v-bind:class="jobCase.statusCls">
                                {{jobCase.applyStatusText}}
                            </div>
                        </div>
                        <section class="base-infos">
                            <div class="info-item">
                                案件名：{{jobCase.caseName}}
                            </div>
                            <div class="info-item-long info-item">
                                <div class="label-desc">
                                    案件の説明：
                                </div>
                                <div class="txt">
                                    {{jobCase.description}}
                                </div>
                            </div>
                            <div class="info-item info-item-long">
                                <div class="label-tools">
                                    希望開発ツール：
                                </div>
                                <div>
                                    {{jobCase.developTools}}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="label">業務期間：{{jobCase.deadlineVal}}
                                </div>
                            </div>
                            <div class="info-item info-item-last">
                                <div class="label">報酬(税別)：{{+parseFloat(jobCase.bonusMoney*0.9).toFixed(1)}}万円<span class="required"></span>
                                    <span>（{{jobCase.bonusMoneyNegotiable ? "相談可能" : "相談不可"}}）</span>
                                </div>
                            </div>
                        </section>
                        <section class="functions-infos">
                            <div class="caption-wrapper">
                                <i class="el-icon-menu"></i>
                                <div class="caption">機能の詳細</div>
                            </div>
                            <div class="functions-item"
                                v-for="(func, index) in jobCase.functions">
                                <div class="index">
                                    <i class="el-icon-caret-right"></i>
                                    機能{{index+1}}：
                                </div>
                                <div class="desc">
                                    {{func.functionDesc}}
                                </div>
                            </div>
                        </section>
                        <section class="client-infos">
							<div class="caption-wrapper">
                                <i class="el-icon-user-solid"></i>
                                <div class="caption">クライアントの情報</div>
                            </div>
                            <el-card class="box-card">
								<div>
									<span class="c-label">ユーザ名:&nbsp;&nbsp;&nbsp;<span>{{cust.username}}</span></span>
									<span class="c-label">居住地:&nbsp;&nbsp;&nbsp;<span>{{cust.addr1}}</span></span>
								</div>
							</el-card>
                        </section>
                        <div class="save-btns">
                            <el-button @click="onApply" v-bind:class="jobCase.applyStatus != 0 ? 'hidden' : ''" type="primary">
                                応募する
                            </el-button>
                            <el-button @click="goMilestoneEdit(jobCase.caseId)" v-if="jobCase.bindWithMe && jobCase.status == 2 && jobCase.milestoneStatus != 1" type="primary">
                                マイルストーン編集
                            </el-button>
                            <el-button @click="goMilestoneProgressUpdate(jobCase.caseId)" v-if="jobCase.bindWithMe && jobCase.status == 2 && jobCase.milestoneStatus == 1" type="primary">
                                マイルストーン詳細
                            </el-button>
                        </div>
                    </section>
                </el-main>
            </el-container>
        </el-container>
    </el-container>
</body>

</html>
<script src="./js/utils.js"></script>
<script src="./js/pageJump.js"></script>
<script>
    // elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja);

    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data() {
            return {
                // ログインしたユーザー情報
                user: {},
                noticeCount: 0,
                jobCase: {},
                cust: {},
            };
        },
        mounted() {
            // ユーザー情報をゲット
            const userStr = sessionStorage.getItem("userinfo") || "";
            if (userStr != "") {
                const user = JSON.parse(userStr);
                if (user.type != 2) {
                    goLogin(1);
                } else {
                    this.user = user;
                    axios({
                        method: "GET",
                        url: `/logged/emp/notice/${user.employeeId}`,
                        withCredentials: true,
                    })
                        .then((res = {}) => {
                            const { data: {
                                code,
                                data: noticeCount,
                            } = {} } = res;
                            this.noticeCount = noticeCount;
                        });
                }
            } else {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/login/info",
                    withCredentials: true,
                })
                    .then((res) => {
                        loading.close();
                        const { data: {
                            code,
                            data: user = {},
                        } = {} } = res;
                        if (code != 80011 || user.type != 2) {
                            goLogin();
                        } else {
                            this.user = user;
                            sessionStorage.setItem("userinfo", JSON.stringify(user));
                            axios({
                                method: "GET",
                                url: `/logged/emp/notice/${user.employeeId}`,
                                withCredentials: true,
                            })
                                .then((res = {}) => {
                                    const { data: {
                                        code,
                                        data: noticeCount,
                                    } = {} } = res;
                                    this.noticeCount = noticeCount;
                                });
                        }
                    })
            }

            const caseId = getURLParam("caseId");
            const loading = this.$loading({
                lock: true,
                text: 'Loading',
                spinner: 'el-icon-loading',
                background: 'rgba(0, 0, 0, 0.1)'
            });
            axios({
                method: "POST",
                url: "/logged/case/getWithCurrEmp",
                data: {
                    caseId,
                },
                withCredentials: true,
            })
                .then((res = {}) => {
                    loading.close();
                    const { data: { data = {} } = {}} = res;
                    const {
                        c: jobCase = {},
                        caseApply,
                        cust,
                    } = data;
                    this.cust = cust;
                    // 日付のフォーマット処理
                    const {
                        deadline,
                        status,
                        milestoneStatus,
                        developTools = "",
                    } = jobCase;
                    const deadlineVal = dateFormat(deadline);
                    jobCase.deadlineVal = deadlineVal;

                    if (developTools == null || developTools == "") {
                        jobCase.developTools = "指定なし";
                    }

                    this.jobCase = jobCase;

                    // 応募状況
                    if (caseApply == null) {
                        this.jobCase.applyStatus = 0;
                        this.jobCase.statusCls = "hidden";
                    } else {
                        const { bind } = caseApply;
                        if (bind == false) {
                            this.jobCase.bindWithMe = false;
                        } else {
							this.jobCase.bindWithMe = true;
						}
                        if (status == 1) {
                            this.jobCase.applyStatus = 1;
                            this.jobCase.applyStatusText = "応募中";
                            this.jobCase.statusCls = "status status-1";
                        }
                        if (status == 2 && !bind) {
                            this.jobCase.applyStatus = 2;
                            this.jobCase.applyStatusText = "応募終了";
                            this.jobCase.statusCls = "status status-2";
                        }
                        if (status == 2 && bind) {
                            this.jobCase.applyStatus = 3;
                            this.jobCase.applyStatusText = "案件作業中";
                            this.jobCase.statusCls = "status status-3";
                        }
                        if (status == 3 && bind) {
                            this.jobCase.applyStatus = 4;
                            this.jobCase.applyStatusText = "案件作業終了";
                            this.jobCase.statusCls = "status status-4";
                        }
                        
                        const tom = getURLParam("tom");
                        if (tom == 1) {
                            if (status == 2 && milestoneStatus ==0) {
                                location.replace(`/milestoneEdit.html?caseId=${caseId}`);
                            }
                            if (status == 2 && milestoneStatus == 1) {
                                location.replace(`/milestoneProgressUpdate.html?caseId=${caseId}`);
                            }
                        }
                    }
                });
        },
        methods: {
            goJobCases,
            goEmployeeInfo,
            goEmployeeApplyHistory,
            goEmployeeNotification,
            goJobCases,
            goMilestoneEdit,
            goMilestoneProgressUpdate,
            goBack() {
                window.history.back();
            },
            logout() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/logout",
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        loading.close();
                        const { data: {
                            code,
                            msg = "",
                        } = {} } = res;
                        this.$message.success(msg);
                        sessionStorage.removeItem("userinfo");
                        setTimeout(() => goLogin(1), 1000);
                    });
            },
            onApply() {
                this.$confirm(`応募すると${this.user.name}さんの職歴をクライアントに送ります、よろしいですか?`, '確認', {
                    confirmButtonText: '応募する',
                    cancelButtonText: "キャンセル",
                    type: 'warning',
                    center: false,
                })
                    .then(() => {
                        const loading = this.$loading({
                            lock: true,
                            text: 'Loading',
                            spinner: 'el-icon-loading',
                            background: 'rgba(0, 0, 0, 0.1)'
                        });
                        const {
                            caseId,
                            customerId,
                            caseName,
                        } = this.jobCase;
                        axios({
                            method: "POST",
                            url: "/logged/case/apply",
                            data: {
                                caseId,
                                customerId,
                                caseName,
                            },
                            withCredentials: true,
                        })
                            .then((res = {}) => {
                                loading.close();
                                const { data: {
                                    code,
                                    msg = "新規案件に応募できませんでした",
                                } = {} } = res;
                                if (code == 20011) {
                                    this.$confirm('クライアントが確認するまでしばらくお待ちください', '応募が完了しました', {
                                        confirmButtonText: '了解です',
                                        type: 'success',
                                        center: true,
                                        showCancelButton: false,
                                    });

                                    const jobCase = { ...this.jobCase };
                                    jobCase.applyStatus = 1;
                                    jobCase.applyStatusText = "応募中";
                                    jobCase.statusCls = "status status-1";
                                    this.jobCase = jobCase;
                                } else {
                                    this.$message.error(msg);
                                }
                            });
                    });
            }
        }
    });
</script>