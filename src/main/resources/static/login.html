<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログインページ</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css?family=Sawarabi+Mincho" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/login.css">

    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
    <script src="//cdn.jsdelivr.net/npm/@element-plus/icons-vue"></script>
    <script src="js/utils.js"></script>
</head>
<body >
    <!-- ヘッドの部分 各々の画面は同じです -->
    <header class="common-header">
        <div class="logo">
            ブリッジ
        </div>
        <div class="login-info">
            未登録
        </div>
    </header>

    <!-- メインの部分 -->
    <main class="common-mian common-mian-nologin" id="app" v-cloak>

        <el-container class="login-container-outer">
            <el-container class="login-container">
                <div class="caption">
                    あなたの理想と実現の橋渡しを
                </div>
                <div class="login-form-wrapper">
                    <div class="edit-item-wrapper">
                        <div class="form-item">
                            <label class="label" for="">
                                ユーザ名：<br />（社員番号）
                            </label>
                            <el-input 
                                clearable
                                placeholder="ユーザ名・社員番号を入力してください"
                                @input="errClean('username')"
                                v-bind:class="errors.username  ? 'input-err' : ''"
                                v-model="loginInfo.username"></el-input>
                        </div>
                        <div v-bind:class="errors.username ? 'err-item' : 'opt-item-hidden'">
                            <i class="el-icon-warning error-icon"></i>
                            ユーザ名を入力してください
                        </div>
                    </div>
                    <div class="edit-item-wrapper">
                        <div class="form-item">
                            <label class="label"  for="">
                                パスワード：
                            </label>
                            <el-input 
                                clearable
                                placeholder="パスワードを入力してください"
                                show-password
                                @input="errClean('password')"
                                v-bind:class="errors.password ? 'input-err' : ''"
                                v-model="loginInfo.password"></el-input>
                        </div>
                        <div v-bind:class="errors.password ? 'err-item' : 'opt-item-hidden'">
                            <i class="el-icon-warning error-icon"></i>
                            パスワードを入力してください
                        </div>
                    </div>
                    <div class="edit-item-wrapper">
                        <div class="form-item">
                            <label class="label radio-label"  for="">
                                あなたは：
                            </label>
                            <el-radio-group v-model="loginInfo.type">
                                <el-radio :label="1">お客様</el-radio>
                                <el-radio :label="2">社員</el-radio>
                                <el-radio :label="3">管理者</el-radio>
                            </el-radio-group>
                        </div>
                    </div>
                    <div class="register-guide">
                        <div class="tips"><i class="el-icon-question"></i>アカウントがない？</div>
                        <div class="guide-wrapper">
                            <div>
                                あなたは：
                            </div>
                            <div>
                                <span class="guide-item" @click="goCustomerRegister">お客様</span>
                                <span class="guide-item" @click="goEmployeeRegister">社員</span>
                            </div>
                        </div>
                    </div>
                    <div class="btn-wrapper">
                        <el-button 
                            @click="onLogin"
                            type="primary">
                            ログイン
                        </el-button>
                    </div>
                </div>
            </el-container>
        </el-container>
    </main>
</body>
</html>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="./js/pageJump.js"></script>
<script>
	// elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja); 
       
    let vm;
    vm = new Vue({

        // id はapp の属性の中の部分を管理する
        el: "#app",
        data(){
            return {
                // html の中の　v-model　属性と同じ値
                loginInfo: {
                    username: "",
                    password: "",
                    type: 1,
				},
                errors: {
                    username: false,
                    password: false,
                }
            };
        },
        mounted() {
            const emp = getURLParam("emp");
            if (emp == "1") {
                this.loginInfo.type = 2;
            }
        },
        methods: {
            goEmployeeRegister,
            goCustomerRegister,
            goJobCases,
            goCustomerCaseEdit,
            errClean(itemName) {
                if (itemName == "username") {
                    this.errors.username = false;
                    return;
                }
                if (itemName == "password") {
                    this.errors.password = false;
                    this.errors.passwordFormat = false;
                    return;
                }
                this.errors[itemName] = false;
            },
            onLogin() {
                const {
                    username = "",
                    password = "",
                    type,
                } = this.loginInfo;
                let flag = true;
                if (username == "") {
                    flag = false;
                    this.errors.username = true;
                }
                if (password == "") {
                    flag = false;
                    this.errors.password = true;
                }
                if (!flag) {
                    return;
                }

                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });

                axios({
                    method: "POST",
                    url: "/login",
                    data: this.loginInfo,
                    withCredentials: true
                })
                    .then((res) => {
                        const { data: {
                            code,
                            msg,
                        } = {} } = res;
                        if (code == 90050) {
                            this.$message.error(msg);
                        } else {
                            this.$message.success("ログインしました！");
                            setTimeout(() => {
                                if (type == 1) {
                                    goCustomerCaseEdit();
                                }
                                if (type == 2) {
                                    goJobCases();
                                }
                            }, 1000);
                        }
                    })

                //TODO: サーバーに送る
                
                
            }
        },
    });
</script>