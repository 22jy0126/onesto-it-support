<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TODO: ページの名にチェンジする -->
    <title>お客様の案件登録情報確認</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- システム共用のスタイルはこのファイルに追加する -->
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/jobCase.css"/>
    <!-- TODO: 作るHTMLとペアでCSSファイルを作り、なるべく同じファイル名にする -->
    <link rel="stylesheet" href="./css/customerCaseDetail.css" />

    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="./js/pageJump.js"></script>
    <script src="js/utils.js"></script>
</head>

<body>
    <el-container id="app" v-cloak>
        <!-- ヘッドの部分 各々の画面は同じです -->
        <header class="common-header">
            <div class="logo">
                ブリッジ
            </div>
            <div class="login-info">
                {{user.name}}さん、こんにちは！
                <span class="logout" @click="logout">ログアウト</span>
            </div>
        </header>

        <!-- メインの部分 -->
        <el-container class="common-mian job-case-main">
            <!-- サイドメニュー -->
            <el-aside width="200px">
                <!-- TODO: default-active は今いるのメニューです -->
                <el-menu default-active="2" class="el-menu-vertical-demo">
                    <el-menu-item index="1">新規案件登録</el-menu-item>
                    <el-menu-item index="2" @click="goCustomerCaseView">私の案件</el-menu-item>
                    <el-menu-item index="3">通知</el-menu-item>
                </el-menu>
            </el-aside>

            <el-container class="customer-case-detail-container">
                <el-main>
                    <!-- TODO: 内容はここに書く -->
                    <section>
                            <div class="caption-wrapper">
                                <i class="el-icon-s-order"></i>
                                <div class="caption">案件の基本情報</div> 
                                <div v-if="(+jobCase.status) > 0" v-bind:class="jobCase.statusCls">
                                    {{jobCase.applyStatusText}}
                                </div>
                            </div> 
                            <section class="base-infos">
                                <div class="info-item">
                                    案件名：{{jobCase.caseName}}
                                </div>
                                <div class="info-item-long info-item">
                                    <div class="label-desc">
                                        案件の説明：
                                    </div>
                                    <div class="txt">
                                        {{jobCase.description}}
                                    </div>
                                </div>
                                <div class="info-item info-item-long">
                                    <div class="label-tools">
                                        希望開発ツール：
                                    </div>
                                    <div>
                                        {{jobCase.developTools}}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="label">業務期間：{{jobCase.deadlineVal}}
                                    </div>
                                </div>
                                <div class="info-item info-item-last">
                                    <div class="label">報酬：{{jobCase.bonusMoney}}万円<span class="required"></span>
                                        <span>（{{jobCase.bonusMoneyNegotiable ? "相談可能" : "相談不可"}}）</span>
                                    </div>
                                </div>
                            </section>
                            
                            <section class="functions-infos">
                                <div class="caption-wrapper">
                                    <i class="el-icon-menu"></i>
                                    <div class="caption">機能の詳細</div>
                                </div>
                                <div class="functions-item" v-for="(func, index) in jobCase.functions">
                                    <div class="index">
                                        <i class="el-icon-caret-right"></i>
                                        機能{{index+1}}：
                                    </div>
                                    <div class="desc">
                                        {{func.functionDesc}}
                                    </div>
                                </div>
                            </section>
                            <div v-if="(+jobCase.status) == 0" class="save-btns">
                                <el-button 
                                    @click="onBackPage"
                                    type="primary">編集に戻る</el-button>
                                <el-button 
                                    @click="onCaseCreate"
                                    type="primary">公開する</el-button>
                                <el-button 
                                    @click="onDraftSave"
                                    type="info">下書きとして保存</el-button>
                            </div>
                            <div v-if="(+jobCase.status) == 2" class="save-btns">
                                <el-button @click="onMilestoneCheck" type="primary">マイルストーンをチェック</el-button>
                                <el-button type="success">案件終了</el-button>
                            </div>
                            <div v-if="(+jobCase.status) == 1" class="save-btns">
                                <el-button type="danger">案件削除</el-button>
                            </div>
                    </section>
                    
                </el-main>
            </el-container>
        </el-container>
    </el-container>

</body>

</html>
<script>
    // elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja);

    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data() {
            return {
                // ログインしたユーザー情報
                user: {
                    // avatarUrl: "https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png", //アバター画像
                    // username: "鈴木　奈々", // ユーザー名
                    // noticeCount: 2, // 通知数
                },
                jobCase: {},
            };
        },
        mounted() {
            // ユーザー情報をゲット
            const userStr = sessionStorage.getItem("userinfo") || "";
            if (userStr != "") {
                const user = JSON.parse(userStr);
                if (user.type != 1) {
                    goLogin();
                } else {
                    this.user = user;
                }
            } else {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/login/info",
                    withCredentials: true,
                })
                    .then((res) => {
                        loading.close();
                        const { data: {
                            code,
                            data: user = {},
                        } = {} } = res;
                        if (code != 80011 || user.type != 1) {
                            goLogin();
                        } else {
                            this.user = user;
                            this.jobCase.customerId = user.customerId;
                            sessionStorage.setItem("userinfo", JSON.stringify(user));
                        }
                    })
            }
            const caseId = getURLParam("caseId") || "";
            if (caseId != "") {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "POST",
                    url: "/logged/case/get",
                    data: {
                        caseId,
                    },
                    withCredentials: true,
                })
                    .then((res ={}) => {
                        const { data ={}} = res;
                        loading.close();
                        const {
                            code,
                            data: jobCase,
                        } = data;
                        // jobCase = jobCase;
                        // 日付のフォーマット処理
                        const {
                            deadline,
                            status,
                        } = jobCase;
                        const deadlineVal = dateFormat(deadline);
                        jobCase.deadlineVal = deadlineVal;

                        if (status == 1) {
                            jobCase.applyStatus = 1;
                            jobCase.applyStatusText = "応募中";
                            jobCase.statusCls = "status status-1";
                        }
                        if (status == 2) {
                            jobCase.applyStatus = 3;
                            jobCase.applyStatusText = "案件作業中";
                            jobCase.statusCls = "status status-3";
                        }
                        if (status == 3) {
                            jobCase.applyStatus = 4;
                            jobCase.applyStatusText = "案件作業終了";
                            jobCase.statusCls = "status status-4";
                        }
                        this.jobCase = jobCase;
                    });
                
            } else {
                const jobCaseStr = localStorage.getItem("tempJobCase");
                const jobCase = JSON.parse(jobCaseStr);
                // 日付のフォーマット処理
                const {
                    deadline,
                    status,
                } = jobCase;
                const deadlineVal = dateFormat(deadline);
                jobCase.deadlineVal = deadlineVal;
                this.jobCase = jobCase;
            }

            
        },
        methods: {
            goCustomerCaseView,
            goMilestoneDetailConfirm,
            onBackPage() {
                window.history.back();
            },
            caseSave(status, succMsg, errMsg) {
                this.jobCase.status = status;
                this.jobCase.customerId = this.user.customerId;
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "POST",
                    url: "/logged/case/saveCase",
                    data: this.jobCase,
                    withCredentials: true,
                })
                    .then((res) => {
                        loading.close();
                        const { data: {
                            code,
                            data,
                        } = {} } = res;
                        if (code == 20011) {
                            this.$message.success(succMsg);
                            if (status == 1) {
                                localStorage.removeItem("tempJobCase");
                            }
                        } else {
                            this.$message.error(errMsg);
                        }
                    });
            },
            onCaseCreate() {
                this.caseSave(1, "新規案件を登録しました！", "只今案件の登録ができません、後でもう一度お試しください！");
            },
            onDraftSave() {
                this.caseSave(0, "下書きを保存しました！", "只今案件の保存ができません、後でもう一度お試しください！");
            },
            logout() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/logout",
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        loading.close();
                        const { data: {
                            code,
                            msg = "",
                        } = {} } = res;
                        this.$message.success(msg);
                        sessionStorage.removeItem("userinfo");
                        setTimeout(() => goLogin(1), 1000);
                    });
            },
            onMilestoneCheck() {
                const ms = getURLParam("ms") || "";
                // debugger;
                if (ms == 1) {
                    goMilestoneProgressConfirm();
                } else {
                    goMilestoneDetailConfirm();
                }
            },
            logout() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/logout",
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        loading.close();
                        const { data: {
                            code,
                            msg = "",
                        } = {} } = res;
                        this.$message.success(msg);
                        sessionStorage.removeItem("userinfo");
                        setTimeout(() => goLogin(), 1000);
                    });
            },
        }
    });
</script>