<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TODO: ページの名にチェンジする -->
    <title>求人一覧</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- システム共用のスタイルはこのファイルに追加する -->
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/milestoneEdit.css">

    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>

</head>

<body>
    <el-container id="app" v-cloak>
        <!-- ヘッドの部分 各々の画面は同じです -->
        <header class="common-header">
            <div class="logo">
                ブリッジ
            </div>
            <div class="login-info">
                <el-badge :value="user.noticeCount" class="item">
                    <el-avatar size="medium" :src="user.avatarUrl"></el-avatar>
                </el-badge>
                {{user.username}}さん、こんにちは！
            </div>
        </header>

        <!-- メインの部分 -->
        <el-container class="common-mian job-case-main">
            <!-- サイドメニュー -->
            <el-aside width="200px">
                <!-- TODO: default-active は今いるのメニューです -->
                <el-menu default-active="3" class="el-menu-vertical-demo">
                    <el-menu-item index="1" @click="goJobCases">求人一覧</el-menu-item>
                    <el-menu-item index="2">個人履歴</el-menu-item>
                    <el-menu-item index="3">応募歴史</el-menu-item>
                    <el-menu-item index="4">通知</el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-main>
                    <div class="milestone-edit-container">
                        <div class="goback" @click="goback">
                            <i class="el-icon-back"></i>
                            案件詳細に戻る
                        </div>
                        <div class="caption">
                            <i class="el-icon-s-order"></i>
                            {{jobCase.caseName}}
                        </div>
                        <div class="sub-caption">
                            マイルストーンの編集
                        </div>
                        <el-timeline>
                            <el-timeline-item
                                v-for="(milestoneItem, index) in jobCase.milestones"
                                :key="index"
                                size="large">
                              <div class="milestone-item">
                                <div class="func-edit-wrapper">
                                    <div class="milestone-edit">
                                        <div class="label">タイトル<span class="required">（必須）</span></div>
                                        <el-input 
                                            draggable="false"
                                            v-bind:class="milestoneItem.nameErr ? 'input-err' : ''"
                                            :rows="3"
                                            placeholder="例：設計完成" 
                                            v-model="milestoneItem.name" 
                                            @input="errClear(index, 'name')"
                                            clearable>
                                        </el-input>
                                    </div>
                                    <!-- <div>1111{{milestoneItem.nameErr}}</div> -->
                                    <div v-bind:class="milestoneItem.nameErr ? 'err-item err-item-func' : 'opt-item-hidden'">
                                        <i class="el-icon-warning error-icon"></i>
                                        
                                        マイルストーン名を入力してください
                                    </div>
                                </div>
                                <div class="func-edit-wrapper">
                                    <div class="milestone-edit">
                                        <div class="label">詳細<span class="required">（必須）</span></div>
                                        <el-input 
                                            draggable="false"
                                            v-bind:class="milestoneItem.descErr ? 'input-err' : ''"
                                            type="textarea"
                                            :rows="3"
                                            placeholder="例：アクティビティ図の完成..." 
                                            v-model="milestoneItem.description" 
                                            @input="errClear(index, 'desc')"
                                            clearable>
                                        </el-input>
                                    </div>
                                    <div v-bind:class="milestoneItem.descErr ? 'err-item err-item-func' : 'opt-item-hidden'">
                                        <i class="el-icon-warning error-icon"></i>
                                        マイルストーンの説明を入力してください
                                    </div>
                                </div>
                                <div v-bind:class="milestoneItem.isComment ? 'comment-view' : 'hidden'">
                                    ※コメント： {{milestoneItem.comment}}
                                </div>
                                <div class="opts">
                                    <div 
                                        @click="onMilestonenUp(index)"
                                        v-bind:class="index==0 ? 'opt-item-hidden' : 'opt-item'">
                                        <i class="el-icon-top"></i>
                                        上に移動
                                    </div>
                                    <div 
                                        @click="onMilestonenDown(index)"
                                        v-bind:class="index==(jobCase.milestones.length-1) ? 'opt-item-hidden' : 'opt-item'">
                                        <i class="el-icon-bottom"></i>
                                        下に移動
                                    </div>
                                    <el-popconfirm
                                        confirm-button-text='削除'
                                        cancel-button-text='削除しない' 
                                        icon="el-icon-info" 
                                        icon-color="red"
                                        @confirm="onMilestonenDel(index)"
                                        title="削除したマイルストーンは戻らない、よろしいですか?">
                                        <el-button 
                                            slot="reference" 
                                            icon="el-icon-delete"
                                            v-bind:class="jobCase.milestones.length==1 ? 'opt-item-hidden' : 'opt-item opt-item-del'">
                                            削除
                                        </el-button>
                                    </el-popconfirm>
                                </div>
                              </div>
                            </el-timeline-item>
                          </el-timeline>
                    </div>
                    <div class="btns-container">
                        <el-button 
                            icon="el-icon-plus"
                            @click="onMilestonenAdd" 
                        >
                            マイルストーン追加
                        </el-button>
                    </div>
                    <div class="btns-container">
                        <el-button type="primary" 
                            @click="onFinish"
                        >
                            クライアントに送る
                        </el-button>
                        <el-button type="info">
                            下書きとして保存
                        </el-button>
                    </div>
                </el-main>
            </el-container>
        </el-container>
    </el-container>

</body>

</html>
<script src="./js/pageJump.js"></script>
<script>
    // elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja);

    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data() {
            return {
                // ログインしたユーザー情報
                user: {
                    avatarUrl: "https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png", //アバター画像
                    username: "鈴木　奈々", // ユーザー名
                    noticeCount: 2, // 通知数
                },
                jobCase: {
                    caseName: "学生管理システムの作成",
                    milestones: [{
                        nameErr: false,
                        descErr: false,
                        isComment: true,
                        comment: "もうちょっど詳しく書いてほうしい",
                        // name: "設計",
                        // description: "設計設計設計設計設計設計設計設計設計設計設計設計設計設計設計設計設計設計設計設計設計"
                    }],
                },
            };
        },
        methods: {
            goJobCases,
            goback() {
                window.history.back();
            },
            onMilestonenDel(index) {
                const {
                    milestones = [],
                } = this.jobCase;
                milestones.splice(index, 1);
            },
            onMilestonenAdd() {
                const {
                    milestones = [],
                } = this.jobCase;
                milestones.push({
                    nameErr: false,
                    descErr: false,
                });
            },
            onMilestonenUp(index) {
                const {
                    milestones = [],
                } = this.jobCase;
                const target = milestones[index];
                milestones.splice(index, 1);
                milestones.splice(index - 1, 0, target);
            },
            onMilestonenDown(index) {
                const {
                    milestones = [],
                } = this.jobCase;
                const target = milestones[index];
                milestones.splice(index, 1);
                milestones.splice(index + 1, 0, target);
            },
            errClear(index, attr) {
                const {
                    milestones = [],
                } = this.jobCase;
                const attrName = attr + "Err";
                milestones[index][attrName] = false;
            },
            onFinish() {
                const {
                    milestones = [],
                } = this.jobCase;
                let flag = true;
                milestones.forEach((item = {}) => {
                    const { 
                        name = "",
                        description = "",
                    } = item;
                    if (name == "") {
                        item.nameErr = true;
                        flag = false;
                    }
                    if (description == "") {
                        flag = false;
                        item.descErr = true;
                    }
                });
                if (!flag) {
                    this.$message.error('未記入の必須項目があります。もう一度チェックしてください！');
                    return;
                }

                //TODO: サーバーにマイルストーンのデータを送る
                this.$confirm('確認するまでしばらくお待ちください', 'クライアントに送りました', {
                    confirmButtonText: '分かりました',
                    type: 'success',
                    center: true,
                    showCancelButton: false,
                });
            }
        }
    });
</script>