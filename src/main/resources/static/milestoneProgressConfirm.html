<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイルストーンの進捗確認</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- システム共用のスタイルはこのファイルに追加する -->
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/milestoneDetail.css">
    <!-- TODO: 作るHTMLとペアでCSSファイルを作り、なるべく同じファイル名にする -->

    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
    <el-container id="app" v-cloak>
        <!-- ヘッドの部分 各々の画面は同じです -->
        <header class="common-header">
            <div class="logo">
                ブリッジ
            </div>
            <div class="login-info">
                {{user.name}}さん、こんにちは！
                <span class="logout" @click="logout">ログアウト</span>
            </div>
        </header>

        <!-- メインの部分 -->
        <el-container class="common-mian job-case-main">
            <!-- サイドメニュー -->
            <el-aside width="200px">
                <!-- TODO: default-active は今いるのメニューです -->
                <el-menu default-active="2" class="el-menu-vertical-demo">
                    <el-menu-item index="1" @click="goCustomerCaseEdit">新規案件登録</el-menu-item>
                    <el-menu-item index="2" @click="goCustomerCaseView">私の案件</el-menu-item>
                    <el-menu-item index="3" @click="goCustomerNotification">
                        <el-badge v-if="noticeCount > 0" :value="noticeCount" class="notice-badge">
                            <div>通知</div>
                        </el-badge>
                        <div v-if="noticeCount == 0">通知</div>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-main>
                    <div class="milestone-detail-container">
                        <div class="goback" @click="goback">
                            <i class="el-icon-back"></i>
                            戻る
                        </div>
                        <div class="caption">
                            <i class="el-icon-s-order"></i>
                            {{jobCase.caseName}}
                        </div>
                        <div class="sub-caption">
                            マイルストーンの進捗
                        </div>
                        <section class="milestone-wrapper">
                            <el-timeline>
                                <el-timeline-item
                                    v-for="(milestoneItem, index) in milestones"
                                    :key="index"
                                    :color="milestoneItem.color"
                                    size="large">
                                    <div class="name">
                                        <span>{{milestoneItem.name}}</span>
                                        <span v-bind:class="milestoneItem.markCls">{{milestoneItem.statusText}}</span>
                                    </div>
                                    <div class="desc">
                                        {{milestoneItem.description}}
                                    </div>
                                    <div class="opt-line" v-if="milestoneItem.status == 3">
                                        <span v-bind:class="!milestoneItem.isComment && milestoneItem.status == 3 ? 'comment-add' : 'hidden'" 
                                            @click="onCommentAdd(index)">
                                            完成物についてのコメントを追加する
                                        </span>
                                        <div v-bind:class="!milestoneItem.isComment ? 'hidden' : 'comment-edit'">
                                            <el-input 
                                                class="comment-input"
                                                type="textarea"
                                                :rows="3"
                                                placeholder="完成物についてのコメントを入力してください" 
                                                v-model="milestoneItem.comment" 
                                                clearable>
                                            </el-input>
                                            <div class="btn-wrapper">
                                                <el-popconfirm
                                                    confirm-button-text='キャンセル'
                                                    cancel-button-text='キャンセルしない' 
                                                    icon="el-icon-info" 
                                                    icon-color="red"
                                                    @confirm="onCommentCancel(index)"
                                                    title="キャンセルしたコメントは戻りません、よろしいですか?">
                                                    <el-button 
                                                        slot="reference" 
                                                        class="opt-item-del">
                                                        キャンセル
                                                    </el-button>
                                                </el-popconfirm>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="milestoneItem.status == 2 && milestoneItem.isComment == true"
                                        class="comment-view">
                                        ※コメント： {{milestoneItem.comment}}
                                    </div>
                                    <div v-bind:class="milestoneItem.status != 3 ? 'hidden' : 'opt-line'">
                                        <el-button 
                                            size="small" 
                                            @click="onConfirm(index)"
                                            type="primary">
                                            作業完成確認
                                        </el-button>
                                        <el-button 
                                            size="small" 
                                            @click="onUpd(index)"
                                            type="info">
                                            修正を依頼する
                                        </el-button>
                                    </div>
                                </el-timeline-item>
                            </el-timeline>
                        </section>
                    </div>
                </el-main>
            </el-container>
        </el-container>
    </el-container>

</body>

</html>
<script src="./js/consts.js"></script>
<script src="./js/pageJump.js"></script>
<script src="./js/utils.js"></script>
<script>
    // elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja);

    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data() {
            return {
                // ログインしたユーザー情報
                user: {},
                noticeCount: 0,
                jobCase: {},
                milestones: [],
            };
        },
        mounted() {
            // ユーザー情報をゲット
            const userStr = sessionStorage.getItem("userinfo") || "";
            if (userStr != "") {
                const user = JSON.parse(userStr);
                if (user.type != 1) {
                    goLogin();
                } else {
                    this.user = user;
                    this.getNoticeCount(user.customerId);
                }
            } else {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/login/info",
                    withCredentials: true,
                })
                    .then((res) => {
                        loading.close();
                        const { data: {
                            code,
                            data: user = {},
                        } = {} } = res;
                        if (code != 80011 || user.type != 1) {
                            goLogin();
                        } else {
                            this.user = user;
                            this.getNoticeCount(user.customerId);
                            this.jobCase.customerId = user.customerId;
                            sessionStorage.setItem("userinfo", JSON.stringify(user));
                        }
                    })
            }
            const caseId = getURLParam("caseId");
            this.jobCase.caseId = caseId;
            this.init();
        },
        methods: {
            init() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                const { caseId } = this.jobCase;
                axios({
                    method: "GET",
                    url: `/logged/case/getbase/${caseId}`,
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        const { data: {
                            code,
                            data = [],
                        } = {} } = res;
                        if (code == 20041) {
                            this.jobCase = data[0];
                            axios({
                                method: "GET",
                                url: `/logged/milestone/get/${caseId}`,
                                withCredentials: true,
                            })
                                .then((res = {}) => {
                                    loading.close();
                                    const { data: {
                                        code,
                                        data: milestones = [],
                                    } = {} } = res;
                                    milestones.forEach(item => {
                                        const { status } = item;
                                        const s = milestoneStatus.find(({ code: c }) => c == status);
                                        item.statusText = s.text;
                                        item.color = s.color;
                                        item.markCls = `mark mark-${s.code}`;
                                    });
                                    this.milestones = milestones;
                                });
                        }
                    })
            },
            goCustomerCaseEdit,
            goCustomerCaseView,
            goCustomerNotification,
            getNoticeCount(customerId) {
                axios({
                    method: "GET",
                    url: `/logged/cust/notice/${customerId}`,
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        const { data: {
                            code,
                            data: noticeCount,
                        } = {} } = res;
                        this.noticeCount = noticeCount;
                    });
            },
            goback() {
                window.history.back();
            },
            onCommentAdd(index) {
                const {
                    milestones = [],
                } = this;
                milestones[index].isComment = true;
            },
            onCommentCancel(index) {
                const {
                    milestones = [],
                } = this;
                milestones[index].comment = "";
                milestones[index].isComment = false;
            },
            onUpd(index) {
                const {
                    milestones = [],
                } = this;
                const milestone = milestones[index];
                milestone.status = 2;
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "POST",
                    url: "/logged/milestone/cust/proc/res",
                    data: {
                        ...this.jobCase,
                        milestone,
                    },
                    withCredentials: true,
                })
                    .then(() => {
                        loading.close();
                        const milestones = [...this.milestones];
                        milestones[index].status = 2;
                        milestones[index].statusText = "作業中";
                        milestones[index].color = "#409eff";
                        milestones[index].markCls = "mark mark-2";
                        this.milestones = milestones;
                        this.$confirm('しばらくお待ちください', '修正を依頼しました', {
                            confirmButtonText: '承諾する',
                            type: 'success',
                            center: true,
                            showCancelButton: false,
                        });
                    })
            },
            onConfirm(index) {
                this.$confirm('確認を完了すると前の状態には戻れません、よろしいですか?', '確認', {
                    confirmButtonText: '確認する',
                    cancelButtonText: "検討する",
                    type: 'warning',
                    center: false,
                })
                    .then(() => {
                        const {
                            milestones = [],
                        } = this;
                        const milestone = milestones[index];
                        milestone.status = 4;
                        milestone.isComment = false;
                        milestone.comment = "";
                        const loading = this.$loading({
                            lock: true,
                            text: 'Loading',
                            spinner: 'el-icon-loading',
                            background: 'rgba(0, 0, 0, 0.1)'
                        });
                        axios({
                            method: "POST",
                            url: "/logged/milestone/cust/proc/confirmed",
                            data: {
                                ...this.jobCase,
                                milestone,
                            },
                            withCredentials: true,
                        })
                            .then(() => {
                                if (index != (milestones.length - 1)) {
                                    const next = milestones[index + 1];
                                    next.status = 2;
                                    axios({
                                        method: "POST",
                                        url: "/logged/milestone/updateOne",
                                        data: next,
                                        withCredentials: true,
                                    })
                                        .then(() => {
                                            loading.close();
                                            const milestones = [...this.milestones];
                                            milestones[index].status = 4;
                                            milestones[index].statusText = "確認済み";
                                            milestones[index].color = "#67c23a";
                                            milestones[index].markCls = "mark mark-4";

                                            milestones[index + 1].status = 2;
                                            milestones[index + 1].statusText = "作業中";
                                            milestones[index + 1].color = "#409eff";
                                            milestones[index + 1].markCls = "mark mark-2";
                                            this.milestones = milestones;
                                        })

                                } else {
                                    loading.close();
                                    const milestones = [...this.milestones];
                                    milestones[index].status = 4;
                                    milestones[index].statusText = "確認済み";
                                    milestones[index].color = "#67c23a";
                                    milestones[index].markCls = "mark mark-4";
                                    this.milestones = milestones;
                                }
                            })
                    })


                

                // this.$confirm('確認を完了すると前の状態には戻れません、よろしいですか?', '確認', {
                //     confirmButtonText: '確認する',
                //     cancelButtonText: "検討する",
                //     type: 'warning',
                //     center: false,
                // })
                //     .then(() => {
                //         const milestones = [...this.milestones];
                //         milestones[index].status = 4;
                //         milestones[index].statusText = "確認済み";
                //         milestones[index].color = "#67c23a";
                //         milestones[index].markCls = "mark mark-4";

                //         milestones[index + 1].status = 2;
                //         milestones[index + 1].statusText = "作業中";
                //         milestones[index + 1].color = "#409eff";
                //         milestones[index + 1].markCls = "mark mark-2";
                //         this.milestones = milestones;
                //     });
            },
            logout() {
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.1)'
                });
                axios({
                    method: "GET",
                    url: "/logout",
                    withCredentials: true,
                })
                    .then((res = {}) => {
                        loading.close();
                        const { data: {
                            code,
                            msg = "",
                        } = {} } = res;
                        this.$message.success(msg);
                        sessionStorage.removeItem("userinfo");
                        setTimeout(() => goLogin(), 1000);
                    });
            }
        }
    });
</script>