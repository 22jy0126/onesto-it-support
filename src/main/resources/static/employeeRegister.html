<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社員情報の登録ページ</title>
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <!-- vue と elementUIの依存css -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    
    <link href="./css/common.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/customerRegister.css">
    <link rel="stylesheet" href="./css/employeeRegister.css">
    
    <!-- vue と elementUIの依存javascript -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/ja.js"></script>
    <script src="//cdn.jsdelivr.net/npm/@element-plus/icons-vue"></script>
    <script src="js/utils.js"></script>
</head>
<body >
    <!-- ヘッドの部分 各々の画面は同じです -->
    <header class="common-header">
        <div class="logo">
            ブリッジ
        </div>
        <div class="login-info">
            未登録
        </div>
    </header>

    <!-- メインの部分 -->
    <main class="common-mian common-mian-nologin" id="app">
        <!-- お客様の登録 -->
        <section class="login-form-container">
            <div class="caption">
                社員情報の登録
            </div>
            <form class="login-form">
				
                <div class="edit-item-wrapper">
                    <div class="form-item">
                        <label class="label" for="">
                            社員番号<span class="required">（必須）</span>
                        </label>
                        <el-input 
                            placeholder="半角、数字6桁、例：123456 " 
                            @input="errClean('employeeId')"
                            v-bind:class="errors.employeeId ? 'input-err' : ''"
                            @blur="employeeIdForbiddenCheck"
                            v-model="employeeInfo.employeeId"></el-input>
                            <div v-bind:class="employeeIdCheck ? 'check-ok' : 'opt-item-hidden'">
                                <i class="el-icon-success"></i>
                            </div>
                    </div>
                    <div v-bind:class="errors.employeeId ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        社員番号を入力してください
                    </div>
                    <div v-bind:class="errors.employeeIdForbidden ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        {{ employeeIdErrMsg }}
                    </div>
                </div>
                
                <div class="edit-item-wrapper">
                    <div class="form-item">
                        <label class="label" for="">
                            氏&nbsp;&nbsp;名<span class="required">（必須）</span>
                        </label>
                        <el-input 
                            placeholder="例：電子　花子" 
                            @input="errClean('name')"
                            v-bind:class="errors.name ? 'input-err' : ''"
                            v-model="employeeInfo.name"></el-input>
                    </div>
                    <div v-bind:class="errors.name ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        氏名を入力してください
                    </div>
                </div>
                
                <div class="form-item">
                    <label class="label" for="">
                        性&nbsp;&nbsp;別<span class="required">（必須）</span>
                    </label>
                    <el-radio-group v-model="employeeInfo.gender">
                        <el-radio :label="0">男性</el-radio>
                        <el-radio :label="1">女性</el-radio>
                        <el-radio :label="2">指定しない</el-radio>
                    </el-radio-group>
                </div>
                <div class="edit-item-wrapper">
                    <div class="form-item">
                        <label class="label" for="">
                            生年月日<span class="required">（必須）</span>
                        </label>
                        <el-date-picker
                            v-bind:class="errors.birthday ? 'input-err' : ''"
                            v-model="employeeInfo.birthday"
                            type="date"
                            @change="errClean('birthday')"
                            format="yyyy年MM月dd日"
                            placeholder="生年月日を選択してください">
                        </el-date-picker>
                    </div>
                    <div v-bind:class="errors.birthday ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        生年月日を選択してください
                    </div>
                </div>
                
                <div class="edit-item-wrapper">
                    <div class="form-item">
                        <label class="label"  for="">
                            パスワード<span class="required">（必須）</span>
                        </label>
                        <el-input 
                            placeholder="例：dqdqyi66&&" 
                            show-password
                            @input="errClean('password')"
                            v-bind:class="(errors.password || errors.passwordFormat) ? 'input-err' : ''"
                            v-model="employeeInfo.password"></el-input>
                        <div class="desc">
                            (8-20桁、数字とアルファベット両方とも1桁以上)
                        </div>
                    </div>
                    <div v-bind:class="errors.password ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        パスワードを入力してください
                    </div>
                    <div v-bind:class="errors.passwordFormat ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        パスワードのフォーマットは正しくない
                    </div>
                </div>
                <div class="edit-item-wrapper">
                    <div class="form-item">
                        <label class="label" for="">
                            パスワード確認<span class="required">（必須）</span>
                        </label>
                        <el-input 
                            placeholder="例：dqdqyi66&&" 
                            show-password
                            @input="errClean('passwordIncon')"
                            v-bind:class="errors.passwordIncon ? 'input-err' : ''"
                            v-model="employeeInfo.password2"></el-input>
                    </div>
                    <div v-bind:class="errors.passwordIncon ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        パスワードは一致しない
                    </div>
                </div>
                <div class="edit-item-wrapper">
                    <div class="form-item">
                        <label class="label" for="">
                            TEL<span class="required">（必須）</span>
                        </label>
                        <el-input 
                            placeholder="例：09000000000" 
                            @input="errClean('tel')"
                            v-bind:class="errors.tel ? 'input-err' : ''"
                            v-model="employeeInfo.tel"></el-input>
                        <div class="desc">
                            (半角、"-"なしで)
                        </div>
                    </div>
                    <div v-bind:class="errors.tel ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        ハイフンなしで正しい電話番号を入力してください
                    </div>
                </div>
                <div class="edit-item-wrapper">
                    <div class="form-item">
                        <label class="label" for="">
                            Email<span class="required">（必須）</span>
                        </label>
                        <el-input 
                            placeholder="例：dennshi@onesto.co.jp" 
                            @input="errClean('email')"
                            v-bind:class="errors.email ? 'input-err' : ''"
                            v-model="employeeInfo.email"></el-input>
                        <div class="desc">
                            (半角)
                        </div>
                    </div>
                    <div v-bind:class="errors.email ? 'err-item' : 'opt-item-hidden'">
                        <i class="el-icon-warning error-icon"></i>
                        正しいメールアドレスを入力してください
                    </div>
                </div>
                <div class="edit-item-wrapper">
                	<div class="form-item">
                    	<label class="label" for="">
                            経験開発ツール<span class="any1">（任意）</span>
                        </label>
                        <el-input 
                            placeholder="例：Java,SQL" 
                            v-bind:class="errors.skill ? 'input-err' : ''"
                            v-model="employeeInfo.skill"></el-input>
                	</div>
            	</div>
            	
            	
				<div class="workHistory-container">
	                    <div class="caption-wrapper">
	                        <label class="label" for="">
								職務経歴<span class="any2">（任意）</span>
							</label> 
	                    </div> 
	                    <div class="workHistory-edit-wrapper" 
	                        v-for="(workItem, index) in employeeInfo.workHistory">
	                        <div class="opts">
	                            <div 
	                                @click="onWorkHistoryUp(index)"
	                                v-bind:class="index==0 ? 'opt-item-hidden' : 'opt-item'">
	                                <i class="el-icon-top"></i>
	                                上に移動
	                            </div>
	                            <div 
	                                @click="onWorkHistoryDown(index)"
	                                v-bind:class="index==(employeeInfo.workHistory.length-1) ? 'opt-item-hidden' : 'opt-item'">
	                                <i class="el-icon-bottom"></i>
	                                下に移動
	                            </div>
	                            <el-popconfirm
	                                confirm-button-text='削除'
	                                cancel-button-text='削除しない' 
	                                icon="el-icon-info" 
	                                icon-color="red"
	                                
	                                @confirm="onWorkHistoryDel(index)"
	                                
	                                title="削除した機能は戻らない、よろしいですか?">
	                                <el-button 
	                                    slot="reference" 
	                                    icon="el-icon-delete"
	                                    class="opt-item opt-item-del">
	                                    削除
	                                </el-button>
	                            </el-popconfirm>
	                        </div>
	                            
							<div  class="history">
							    <table>
							        <tr>
							            <th rowspan="6">
							                経歴の説明
							            </th>
							            <th class="title">
							                経歴名<span class="required">（必須）</span>
							            </th>
							            <td>
							                <el-input 
                                                v-bind:class="workItem.workNameErr ? 'input-err' : ''"
							                	placeholder="例：業務管理システムのリニューアル" 
                                                @input="errHistoryClean('workNameErr', index)"
							                	v-model="workItem.workName">
							                </el-input>
                                            <div v-bind:class="workItem.workNameErr ? 'err-item err-item-history' : 'opt-item-hidden'">
                                                <i class="el-icon-warning error-icon"></i>
                                                経歴名を入力してください
                                            </div>
							            </td>
							        </tr>
							        <tr>
							            <th class="title">
							                開始時期<span class="required">（必須）
							            </th>
							            <td>
							                <div class="block">
							                    <span class="demonstration"></span>
							                    <el-date-picker 
                                                    v-bind:class="workItem.workStartErr ? 'input-err' : ''"
							                    	v-model="workItem.workStart" 
							                    	type="month" 
                                                    @input="errHistoryClean('workStartErr', index)"
							                    	placeholder="Pick a month">
							                    </el-date-picker>
							                </div>
                                            <div v-bind:class="workItem.workStartErr ? 'err-item err-item-history' : 'opt-item-hidden'">
                                                <i class="el-icon-warning error-icon"></i>
                                                開始時期を選択してください
                                            </div>
							            </td>
							        </tr>
                                    <tr>
                                        <th class="title">
                                            開発期間<span class="required">（必須）</span>
                                        </th>
                                        <td>
                                            <el-input-number 
                                                v-bind:class="workItem.workPeriodErr ? 'input-err' : ''"
                                                @input="errHistoryClean('workPeriodErr', index)"
                                                v-model="workItem.workPeriod" :min="1">
                                            </el-input-number> 日
                                            <div v-bind:class="workItem.workPeriodErr ? 'err-item err-item-history' : 'opt-item-hidden'">
                                                <i class="el-icon-warning error-icon"></i>
                                                開発期間を入力してください
                                            </div>
                                        </td>
                                    </tr>
							        <tr>
							            <th class="title">
							                担当内容<span class="required">（必須）</span>
							            </th>
							            <td>
							                <el-input 
							                	placeholder="例：設計、実装" 
                                                @input="errHistoryClean('workChargeErr', index)"
                                                v-bind:class="workItem.workChargeErr ? 'input-err' : ''"
							                	v-model="workItem.workCharge">
							                </el-input>
                                            <div v-bind:class="workItem.workChargeErr ? 'err-item err-item-history' : 'opt-item-hidden'">
                                                <i class="el-icon-warning error-icon"></i>
                                                担当内容を入力してください
                                            </div>
							            </td>
							        </tr>
							        <tr>
							            <th class="title">
							                概要<span class="required">（必須）</span>
							            </th>
							            <td>
							                <el-input 
							                	type="textarea" 
							                	:rows="2" 
                                                @input="errHistoryClean('workContentErr', index)"
                                                v-bind:class="workItem.workContentErr ? 'input-err' : ''"
							                	placeholder="例：企業内の業務管理を支援するためのシステムをリニューアル..." 
							                	v-model="workItem.workContent">
							                </el-input>
                                            <div v-bind:class="workItem.workContentErr ? 'err-item err-item-history' : 'opt-item-hidden'">
                                                <i class="el-icon-warning error-icon"></i>
                                                概要を入力してください
                                            </div>
							            </td>
							        </tr>
							        <tr>
							            <th class="title">
                                            経験開発ツール<span class="any1">（任意）</span>
							            </th>
							            <td>
                                            <el-input placeholder="例：Java,SQL" 
                                                v-model="workItem.skill">
                                            </el-input>
							            </td>
							        </tr>
							    </table>
							</div>
	
	                      </div>
					</div>
                    <el-button 
                        icon="el-icon-plus" 
                        @click="workHistoryAdd">
                        職務履歴を追加
                    </el-button>
                            
                            
                <div class="register-btn-line">
                    <el-button 
                        @click="onCreate"
                        type="primary">登録する</el-button>
                </div>
                
            </form>
        </section>
    </main>
</body>
</html>
<script src="./js/pageJump.js"></script>
<script src="./js/consts.js"></script>
<script>
	// elementの日本語対応
    ELEMENT.locale(ELEMENT.lang.ja); 
       
    let vm;
    vm = new Vue({
        // id はapp の属性の中の部分を管理する
        el: "#app",
        data(){
            return {
                // html の中の　v-model　属性と同じ値
                employeeInfo: {
                    employeeId: "",    //社員番号
                    name: "",         //氏名
                    gender: "",       //性別
                    birthday: "",     //生年月日
                    password: "",     //パスワード
                    password2: "",    //パスワード確認
                    tel: "",          //電話番号
                    email: "",        //メールアドレス
                    skill: "",        //経験開発言語
                    workHistory: [],
				},
				techs,
                // ドラッグドロップ管理
                dragIndex: null,
                employeeIdErrMsg: "",
                employeeIdCheck: false,
                errors: {
                    employeeId: false,
                    employeeIdForbidden: false,
                    name: false,
                    gender: false,
                    birthday: false, 
                    password: false,
                    passwordIncon: false, //二回のパスワード入力は一致しない
                    passwordFormat: false, //パスワードのフォーマットは正しくない
                    tel: false,
                    email: false,
                }
            };
        },
        mounted() {
            const employeeInfoStr = localStorage.getItem("tempEmployeeInfo") || "";
            if (employeeInfoStr != "") {
                const employeeInfo = JSON.parse(employeeInfoStr);
                this.employeeInfo = employeeInfo;
            }
        },
        methods: {
            goEmployeeRegisterConfirm,
			employeeIdForbiddenCheck() {
                const {
                    employeeId = "",
                } = this.employeeInfo;
                if (employeeId == "") {
                    return;
                }
                // TODOサーバに使えるかどうかを検証する
                if (employeeId == "111111") {
                    this.errors.employeeIdForbidden = true;
                    this.employeeIdErrMsg = "入力した社員番号は存在しません！";
                    return;
                } 
                if (employeeId == "222222") {
                    this.errors.employeeIdForbidden = true;
                    this.employeeIdErrMsg = "入力した社員番号は既に登録しました、確認してください！";
                    return;
                }
                this.employeeIdCheck = true;
            },
            errClean(itemName) {
                if (itemName == "employeeId") {
                    this.errors.employeeId = false;
                    this.errors.employeeIdForbidden = false;
                    return;
                }
                if (itemName == "password") {
                    this.errors.password = false;
                    this.errors.passwordFormat = false;
                    return;
                }
                this.errors[itemName] = false;
            },
            errHistoryClean(errType, index) {
                const workHistory = [...this.employeeInfo.workHistory];
                workHistory[index][errType] = false;
                this.employeeInfo.workHistory = workHistory;
            },
            onCreate() {
                const {
                    employeeId = "",
                    name = "",
                    gender= "",       
                    birthday= "",     
                    password= "",     
                    password2= "",    
                    tel= "",          
                    email= "",        
                    requiredTech= "",
                    // workHistory = [],
                } = this.employeeInfo;
                let flag = true;
                // 社員番号必須の検証
                if (employeeId == "") {
                    this.errors.employeeId = true;
                    flag = false;
                }
                // 氏名必須の検証
                if (name == "") {
                    this.errors.name = true;
                    flag = false;
                }
                // パスワードフォーマットの検証
                const pwdRegExp = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,20}$/;
                if (!pwdRegExp.test(password)) {
                    this.errors.passwordFormat = true;
                    flag = false;
                }
                // パスワード二回の入力一致することの検証
                if (password2 != password) {
                    this.errors.passwordIncon = true;
                    flag = false;
                }
                // 生年月日の検証
                if (birthday == "") {
                    this.errors.birthday = true;
                    flag = false;
                }   
                // 電話番号フォーマットの検証
                const telRegExp = /^0\d{9}$/;  //　固定電話
                const mobileRegExp = /^0[789]0\d{8}$/; // 携帯電話
                if (!telRegExp.test(tel) && !mobileRegExp.test(tel)) {
                    this.errors.tel = true;
                    flag = false;
                }
                // メールアドレスフォーマットの検証
                const emailRegExp = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                if (!emailRegExp.test(email)) {
                    this.errors.email = true;
                    flag = false;
                }
                if (!this.employeeIdCheck) {
                    this.$message.error('ユーザ名が使えるかどうか確認してください！');
                    // return;
                }
                const workHistory = [...this.employeeInfo.workHistory];
                
                workHistory.forEach((item = {}) => {
                    const {
                        workName = "",
                        workStart = "",
                        workPeriod = "",
                        workCharge = "",
                        workContent = "",
                    } = item;
                    if (workName == "") {
                        item.workNameErr = true;
                        flag = false;
                    }
                    if (workStart == "") {
                        item.workStartErr = true;
                        flag = false;
                    }
                    if (workPeriod == "") {
                        item.workPeriodErr = true;
                        flag = false;
                    }
                    if (workCharge == "") {
                        item.workChargeErr = true;
                        flag = false;
                    }
                    if (workContent == "") {
                        item.workContentErr = true;
                        flag = false;
                    }
                });
                this.employeeInfo.workHistory = workHistory;

                if (flag == false) {
                    this.$message.error('記入不備な項目があるので、もう一度チェックしてください！');
                    return;
                }

                localStorage.removeItem("tempEmployeeInfo");
                const employeeInfoStr = JSON.stringify(this.employeeInfo);
                localStorage.setItem("tempEmployeeInfo", employeeInfoStr);
                goEmployeeRegisterConfirm();
            },
            workHistoryDel(index) {
                const {
                    workHistory = [],
                } = this.employeeInfo;
                workHistory.splice(index, 1);
            },
            workHistoryAdd() {
                const {
                    workHistory = [],
                } = this.employeeInfo;
                // 職務経歴
                workHistory.push({
                    workName: "",           //経歴名
                    workNameErr: false,
                    workStart: "",          //開発開始時期
                    workStartErr: false,
                    workPeriod: "",         //開発期間
                    workPeriodErr: false,
                    workCharge: "",         //担当内容
                    workChargeErr: false,
                    workContent: "",        //概要
                    workContentErr: false,
                });
            },
            workHistoryUp(index) {
                const {
                    workHistory = [],
                } = this.employeeInfo;
                const target = workHistory[index];
                workHistory.splice(index, 1);
                workHistory.splice(index - 1, 0, target);
            },
            workHistoryDown(index) {
                const {
                    workHistory = [],
                } = this.employeeInfo;
                const target = workHistory[index];
                workHistory.splice(index, 1);
                workHistory.splice(index + 1, 0, target);
            },
        },
    });
</script>